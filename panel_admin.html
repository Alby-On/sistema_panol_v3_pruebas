<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n INACAP</title>

    <style>
        /* Tipograf√≠a y Base */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Banner Superior (INACAP) */
        header {
            background-color: #173753; /* Azul Oscuro Corporativo */
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
        }

        .header-info {
            text-align: right;
        }

        .header-info h2 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .header-info p {
            font-size: 0.9em;
            margin: 5px 0 0;
            color: #b0c4de;
        }

        /* Contenedor Principal */
        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Bot√≥n Volver al Men√∫ */
        .back-button-container {
            margin-bottom: 20px;
        }

        .btn-menu {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
        }

        .btn-menu:hover {
            background-color: #0056b3;
        }

        .btn-menu span {
            margin-right: 8px;
        }

        /* Estructura de Columnas */
        .dashboard-container {
            display: flex;
            gap: 25px;
        }

        .column {
            flex: 1;
        }

        .column h2 {
            font-size: 1.5em;
            color: #173753;
            margin-bottom: 20px;
            padding-left: 5px;
            border-bottom: 2px solid #e1e4e8;
            padding-bottom: 5px;
        }

        /* Estilos de Tarjetas */
        .request-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease-in-out;
            border: 1px solid #f0f2f5;
        }

        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Diferenciaci√≥n visual de tarjetas */
        .pending-requests .request-card {
            border-left: 5px solid #ff9800; /* Naranja para Pendientes */
        }
        .delivered-requests .request-card {
            border-left: 5px solid #4caf50; /* Verde para Entregadas */
        }

        /* Contenido y Etiquetas */
        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }

        .card-header strong {
            font-size: 1.2em;
            color: #007bff;
        }

        .card-detail {
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .card-detail label {
            font-weight: 600;
            color: #555;
            display: inline-block;
            width: 85px;
            vertical-align: top;
        }

        /* BLOQUE PARA MATERIALES */
        .material-block {
            display: flex;
            align-items: flex-start;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dotted #f0f0f0;
        }

        .material-block label {
            flex-shrink: 0;
            width: 85px;
        }

        .material-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .material-list li {
            margin-bottom: 2px;
            font-size: 0.9em;
        }

        .material-list li:before {
            content: "‚Ä¢";
            color: #888;
            display: inline-block;
            width: 1em;
            margin-right: 0.2em;
        }

        .card-status-pending {
            color: #ff9800;
            font-weight: 700;
        }

        .card-status-delivered {
            color: #4caf50;
            font-weight: 700;
        }

        /* Estilos de Acciones (Botones) */
        .actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .actions button {
            padding: 8px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: background-color 0.2s, transform 0.1s;
        }

        .actions button:active {
            transform: scale(0.98);
        }

        .btn-comment {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }

        .btn-comment:hover {
            background-color: #0056b3;
        }

        .btn-no-comment {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
        }

        .btn-no-comment:hover {
            background-color: #ced4da;
        }

        /* Estilos para el Modal y sus elementos */
        #commentModal textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: vertical;
            font-size: 1em;
        }

        #btnEnviarComentario {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #4caf50;
            color: white;
        }

        #commentModal button[onclick="cerrarFormulario()"] {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header>
        <div class="header-title">
            <h1>Gestor de solicitudes </h1>
        </div>
        <div class="header-info">
            <h2>INACAP</h2>
            <p>√Årea Energ√≠a y √Årea Automatizaci√≥n, Electr√≥nica y Rob√≥tica</p>
        </div>
    </header>

    <div class="main-content">
        <div class="back-button-container">
            <a href="menu.html" class="btn-menu">
                <span>&#x2190;</span> Volver al Men√∫
            </a>
        </div>

        <div class="dashboard-container">

            <div class="column pending-requests">
                <h2>‚è≥ Solicitudes Pendientes</h2>
                <div id="pending-container">
                    <p>Cargando solicitudes...</p>
                </div>
            </div>

            <div class="column delivered-requests">
                <h2>‚úÖ Solicitudes Entregadas</h2>
                <div id="delivered-container">
                    <p>Cargando solicitudes...</p>
                </div>
            </div>

        </div>
    </div>

<div id="commentModal" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
    display: none;
    justify-content: center; align-items: center;">

    <div style="background-color: #ffffff; padding: 30px; border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 400px; width: 90%;">

        <h3 style="margin-top: 0; color: #173753;">Agregar Comentario de Entrega</h3>
        <p>Solicitud ID: <strong id="modalSolicitudId"></strong></p>

        <textarea id="modalComentario" rows="5" placeholder="Escriba el comentario de la entrega (ej: equipo completo, falt√≥ calibrar, etc.)"></textarea>

        <button id="btnEnviarComentario">
            Enviar y Guardar
        </button>

        <button onclick="cerrarFormulario()">
            Cancelar
        </button>

        <p id="modalMsg" style="margin-top: 15px; text-align: center; font-weight: 600;"></p>

    </div>
</div>
<script>
    // CONFIGURACI√ìN DE SUPABASE (SIN CAMBIOS)
    const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

    // Crear cliente de Supabase (SIN CAMBIOS)
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Contenedores DOM (SIN CAMBIOS)
    const pendingContainer = document.getElementById('pending-container');
    const deliveredContainer = document.getElementById('delivered-container');

    // Variable global para almacenar el ID de la solicitud actual y el ID del intervalo (SIN CAMBIOS)
    let currentSolicitudId = null;
    let intervalId = null;

    // Funci√≥n auxiliar para formatear fechas (SIN CAMBIOS)
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES');
    };

    // --- L√ìGICA DE INTERFAZ DEL MODAL (SIN CAMBIOS) ---

    window.abrirFormulario = (solicitudId) => {
        currentSolicitudId = solicitudId;
        document.getElementById('modalSolicitudId').textContent = 'S-' + solicitudId;
        document.getElementById('modalComentario').value = ''; // Limpiar textarea
        document.getElementById('modalMsg').textContent = ''; // Limpiar mensaje
        document.getElementById('commentModal').style.display = 'flex';
    };

    window.cerrarFormulario = () => {
        document.getElementById('commentModal').style.display = 'none';
    };

    // --- L√ìGICA DE ACTUALIZACI√ìN DE SUPABASE ---

    // Funci√≥n para iniciar el refresco autom√°tico (SIN CAMBIOS)
    function startAutoRefresh() {
        const intervalTime = 5000;
        if (intervalId) {
            clearInterval(intervalId); // Asegura que solo hay un intervalo corriendo
        }
        intervalId = setInterval(loadDashboardData, intervalTime);
    }
    
    /**
     * Funci√≥n principal para marcar como Entregado, incluyendo la actualizaci√≥n del Comentario.
     * Se usa para el modal (comentario manual) y el bot√≥n "Sin Comentarios".
     */
    async function actualizarComentario(solicitudId, comentario) {
        // Detener el refresco mientras actualizamos
        clearInterval(intervalId);
        document.body.style.cursor = 'wait';

        const isModalUpdate = document.getElementById('commentModal').style.display === 'flex';
        const msgElement = isModalUpdate ? document.getElementById('modalMsg') : null;

        if (msgElement) {
            msgElement.style.color = '#333';
            msgElement.textContent = 'Guardando...';
        }

        const { error } = await supabaseClient
            .from('solicitudes')
            .update({
                estado: 'Entregado',
                fecha_entrega: new Date().toISOString(),
                comentario_entrega: comentario // <--- ACTIVA LA ACTUALIZACI√ìN DE COMENTARIO
            })
            .eq('id', solicitudId);

        if (error) {
            console.error('Error al guardar comentario:', error);
            if (msgElement) {
                msgElement.style.color = '#dc3545';
                msgElement.textContent = '‚ùå Error al guardar: ' + error.message.substring(0, 50) + '...';
            } else {
                alert('Error al guardar: ' + error.message);
            }
            // Reanudar el refresco incluso con error
            document.body.style.cursor = 'default';
            startAutoRefresh();
            return false;
        }

        if (msgElement) {
            msgElement.style.color = '#4caf50';
            msgElement.textContent = '‚úÖ Solicitud actualizada con √©xito.';
            setTimeout(cerrarFormulario, 1000); // Cerrar modal despu√©s de un segundo
        }

        // Recargar datos y reanudar el refresco
        await loadDashboardData();
        document.body.style.cursor = 'default';
        startAutoRefresh();
        return true;
    }


    /**
     * FUNCI√ìN SIMPLE: Marcar Entregado de forma simple.
     */
    window.marcarEntregaSimple = async (solicitudId) => {
        // Detener el refresco mientras actualizamos
        clearInterval(intervalId);
        document.body.style.cursor = 'wait';

        const { error } = await supabaseClient
            .from('solicitudes')
            .update({
                estado: 'Entregado', // SOLO ESTADO
                fecha_entrega: new Date().toISOString() // Y FECHA
            })
            .eq('id', solicitudId);

        if (error) {
            console.error('Error al marcar como entregado:', error);
            alert('‚ùå Error al marcar como entregado: ' + error.message);
        } else {
            console.log(`‚úÖ Solicitud S-${solicitudId} marcada como Entregada.`);
        }

        // Recargar datos y reanudar el refresco
        await loadDashboardData();
        document.body.style.cursor = 'default';
        startAutoRefresh();
        return true;
    };


    // Funci√≥n al presionar "Enviar y Guardar" dentro del modal (SIN CAMBIOS)
    document.getElementById('btnEnviarComentario').onclick = () => {
        const comentario = document.getElementById('modalComentario').value.trim();
        if (!currentSolicitudId) {
            document.getElementById('modalMsg').style.color = '#dc3545';
            document.getElementById('modalMsg').textContent = '‚ö†Ô∏è Error: ID de solicitud no encontrado.';
            return;
        }
        if (!comentario) {
            document.getElementById('modalMsg').style.color = '#ff9800';
            document.getElementById('modalMsg').textContent = '‚ö†Ô∏è El comentario no puede estar vac√≠o.';
            return;
        }
        actualizarComentario(currentSolicitudId, comentario);
    };

    // Funci√≥n al presionar "Sin Comentario" en la tarjeta (guarda el marcador "Sin Comentarios")
    window.guardarSinComentario = async (solicitudId) => {
        if(confirm('¬øDesea registrar "Sin Comentarios" para la Solicitud S-' + solicitudId + '?')) {
            // Llama a la funci√≥n completa de actualizaci√≥n de comentarios
            // Una vez que se guarda "Sin Comentarios", la solicitud desaparecer√° del panel.
            await actualizarComentario(solicitudId, "Sin Comentarios"); 
        }
    };
    

    // Funci√≥n para crear el HTML de una tarjeta (Card)
    const createRequestCard = (solicitud) => {
        const isDelivered = solicitud.estado === 'Entregado';
        const statusClass = isDelivered ? 'card-status-delivered' : 'card-status-pending';
        
        const materiales = solicitud.materiales_solicitados || [];
        const usuarioNombre = solicitud.usuarios?.nombre || 'Desconocido';

        const materialListItems = materiales.map(m => `<li>${m.material} (Cantidad: ${m.cantidad})</li>`).join('');

        let html = `<div class="request-card" data-solicitud-id="${solicitud.id}">
                <div class="card-header">
                    <strong>ID: S-${solicitud.id}</strong>
                    <span>Fecha Solicitud: ${formatDate(solicitud.fecha_solicitud)}</span>
                </div>
                <div class="card-detail"><label>Usuario:</label> ${usuarioNombre}</div>
                <div class="card-detail"><label>Docente:</label> ${solicitud.docente}</div>
                <div class="card-detail"><label>Asignatura:</label> ${solicitud.asignatura}</div>

                <div class="card-detail material-block">
                    <label>Materiales:</label>
                    <ul class="material-list">
                        ${materialListItems.length > 0 ? materialListItems : '<li>Sin materiales registrados.</li>'}
                    </ul>
                </div>

                <div class="card-detail"><label>Estado:</label> <span class="${statusClass}">${solicitud.estado ? solicitud.estado.toUpperCase() : 'N/A'}</span></div>`;

        if (isDelivered) {
            html += `<div class="card-detail"><label>Entrega:</label> ${formatDate(solicitud.fecha_entrega)}</div>
                    <div class="card-detail"><label>Comentario:</label> ${solicitud.comentario_entrega || 'N/A'}</div>`;

            // L√≥gica de botones para tarjetas Entregadas
            // Si la tarjeta est√° siendo mostrada aqu√≠, es porque ya pas√≥ el filtro de loadDashboardData,
            // lo que implica que el comentario est√° pendiente (null, "", o "N/A").
            const needsCommentAction = !solicitud.comentario_entrega || solicitud.comentario_entrega === 'Sin Comentarios' || solicitud.comentario_entrega === 'N/A';
            
            // Puesto que el filtro en loadDashboardData elimina los que dicen "Sin Comentarios", 
            // este bloque solo se ejecutar√° para tarjetas que requieren acci√≥n.
            if (needsCommentAction) {
                html += `<div class="actions">
                            <button class="btn-comment" onclick="abrirFormulario(${solicitud.id})">Agregar/Editar Comentario</button>
                            <button class="btn-no-comment" onclick="guardarSinComentario(${solicitud.id})">Sin Comentario</button>
                        </div>`;
            } 
            // La cl√°usula 'else' anterior (que mostraba "Comentario registrado") ya no es necesaria 
            // porque si tiene un comentario, ya fue filtrada y no llega hasta aqu√≠.

        } else {
            // L√≥gica de botones para tarjetas Pendientes (SOLO 1 bot√≥n)
            html += `<div class="actions">
                        <button class="btn-comment" style="background-color: #4caf50;" onclick="marcarEntregaSimple(${solicitud.id})">Marcar como Entregado</button>
                    </div>`; 
        }

        html += '</div>';
        return html;
    };

    // Funci√≥n: Actualiza el contenedor agregando/quitando/reemplazando tarjetas de forma eficiente. (SIN CAMBIOS)
    function updateContainerDynamically(container, newSolicitudes, emptyMessage) {
        const newIds = newSolicitudes.map(s => String(s.id));

        // 1. ELIMINAR tarjetas viejas
        Array.from(container.children).forEach(card => {
            const cardId = card.dataset.solicitudId;
            if (cardId && !newIds.includes(cardId)) {
                card.remove();
            }
        });

        // 2. AGREGAR/REEMPLAZAR tarjetas
        newSolicitudes.forEach(solicitud => {
            const solicitudIdStr = String(solicitud.id);
            let cardElement = container.querySelector(`[data-solicitud-id="${solicitudIdStr}"]`);

            // Generar el nuevo HTML de la tarjeta
            const cardHtml = createRequestCard(solicitud);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHtml.trim();
            const newCardElement = tempDiv.firstChild;
            newCardElement.dataset.solicitudId = solicitudIdStr;

            if (cardElement) {
                // Reemplazar el elemento completo (asegura la actualizaci√≥n de los botones)
                cardElement.replaceWith(newCardElement);
            } else {
                // Si no existe, a√±adir la nueva tarjeta al inicio
                container.prepend(newCardElement);
            }
        });

        // 3. MENSAJE DE VAC√çO
        const hasCards = container.querySelector('[data-solicitud-id]') !== null;

        if (newSolicitudes.length === 0 && !hasCards) {
             container.innerHTML = `<p>${emptyMessage}</p>`;
        } else if (hasCards) {
            // Eliminar el mensaje de vac√≠o si existen tarjetas
            const emptyP = container.querySelector('p');
            if (emptyP && !emptyP.dataset.solicitudId) {
                emptyP.remove();
            }
        }
    }

    async function loadDashboardData() {
        // La consulta clave: pide todos los datos de las solicitudes, m√°s los materiales y el nombre del usuario relacionado (SIN CAMBIOS)
        const { data: solicitudesData, error } = await supabaseClient
            .from('solicitudes')
            .select(`
                *,
                materiales_solicitados (material, cantidad),
                usuarios (nombre, email) 
            `)
            .order('fecha_solicitud', { ascending: false });

        if (error) {
            console.error("Error al cargar datos:", error);
            pendingContainer.innerHTML = "<p>Error cargando solicitudes.</p>";
            deliveredContainer.innerHTML = "<p>Error cargando solicitudes.</p>";
            return;
        }

        // 1. Separar las pendientes (las que no est√°n 'Entregado')
        const pendientes = solicitudesData.filter(s => s.estado !== "Entregado");

        // 2. Separar las entregadas Y que A√öN requieren acci√≥n de comentario.
        // üéØ MODIFICACI√ìN CLAVE: Solo muestra si el campo de comentario est√° vac√≠o o es nulo.
        const entregadas = solicitudesData.filter(s => {
            const isDelivered = s.estado === "Entregado";
            
            // Solo se muestra si el comentario est√° null, vac√≠o (""), o "N/A".
            const isCommentMissing = !s.comentario_entrega || 
                                     s.comentario_entrega.trim() === '' || 
                                     s.comentario_entrega === 'N/A';
            
            // Si el comentario es "Sin Comentarios", se considera completado y se excluye (ya que !s.comentario_entrega es false)
            return isDelivered && isCommentMissing; 
        });

        // Actualizar din√°micamente el DOM
        updateContainerDynamically(
            pendingContainer,
            pendientes,
            "No hay solicitudes pendientes."
        );

        updateContainerDynamically(
            deliveredContainer,
            entregadas,
            "No hay solicitudes entregadas pendientes de comentario/revisi√≥n."
        );
    }

    // üöÄ Ejecutar carga inicial y comenzar el refresco (SIN CAMBIOS)
    loadDashboardData();
    startAutoRefresh();
</script>
</body>
</html>

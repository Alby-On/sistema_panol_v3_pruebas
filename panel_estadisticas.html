<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estad√≠sticas de Uso del Pa√±ol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --color-primary: #004d99;
            --color-secondary: #28a745;
            --color-menu: #6c757d;
            --color-background: #f4f6f9;
            --color-card: #ffffff;
            --color-text: #333333;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            margin: 0;
            padding: 0;
        }

        /* Banner Azul Corporativo */
        header {
            background-color: #173753;
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .header-title h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
        }

        .header-info {
            text-align: right;
        }

        .header-info h2 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .header-info p {
            font-size: 0.9em;
            margin: 5px 0 0;
            color: #b0c4de;
        }

        /* Contenedor de Botones */
        .dashboard-header {
            padding: 30px 40px 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .print-button, .menu-button {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 700;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .print-button { background-color: var(--color-secondary); }
        .menu-button { background-color: var(--color-menu); }

        .print-button:hover, .menu-button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* Grid de Contenido */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            padding: 0 40px 40px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .chart-container {
            background: var(--color-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-subtle);
            min-height: 500px; /* Aumentado para evitar que se corte el contenido */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-container.stats-mini {
            min-height: 180px;
        }

        h3 {
            color: var(--color-primary);
            font-size: 1.3em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .canvas-wrapper {
            position: relative;
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }

        .comments-content {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 450px;
        }

        @media (max-width: 768px) {
            header, .dashboard-header { padding: 20px; flex-direction: column; text-align: center; }
            .header-info { margin-top: 10px; }
            .dashboard-header { gap: 15px; }
            .dashboard-grid { padding: 15px; }
        }

        @media print {
            header, .dashboard-header { display: none; }
            .dashboard-grid { padding: 0; }
            .chart-container { page-break-inside: avoid; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">
            <h1>Estad√≠sticas de uso del pa√±ol</h1>
        </div>
        <div class="header-info">
            <h2>INACAP</h2>
            <p>√Årea Energ√≠a y √Årea Automatizaci√≥n, Electr√≥nica y Rob√≥tica</p>
        </div>
    </header>

    <div class="dashboard-header">
        <a href="menu.html" class="menu-button">
            <span>‚¨ÖÔ∏è</span> Volver al Men√∫
        </a>
        <button class="print-button" onclick="window.print()">
            <span>üñ®Ô∏è</span> Imprimir reporte
        </button>
    </div>

    <div class="dashboard-grid">
        
        <div class="chart-container stats-mini">
            <h3>üë• Usuarios Registrados</h3>
            <div id="usuariosCount" style="text-align: center; display: flex; flex-direction: column; justify-content: center; flex-grow: 1;">
                <p style="font-size: 4em; color: var(--color-primary); font-weight: 800; margin: 0;">0</p>
                <p style="font-size: 1.2em; color: var(--color-text); margin: 0;">Total en el Sistema</p>
            </div>
        </div>

        <div class="chart-container">
            <h3>ü•á Top 10 Docentes Solicitantes</h3>
            <div class="canvas-wrapper">
                <canvas id="docentesChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üèõÔ∏è Solicitudes por Carrera</h3>
            <div class="canvas-wrapper">
                <canvas id="carrerasChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üî© Materiales m√°s Solicitados</h3>
            <div class="canvas-wrapper">
                <canvas id="materialesChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìö Solicitudes por Asignatura</h3>
            <div class="canvas-wrapper">
                <canvas id="asignaturasChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üí¨ Registro de Novedades</h3>
            <div id="commentsList" class="comments-content">
                <p id="loadingMessage" style="text-align: center; color: #888;">Cargando novedades...</p>
            </div>
        </div>

    </div>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
¬† ¬†
<script>
/* ==============================
   CONFIGURACI√ìN SUPABASE
================================ */

const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

// Crear cliente Supabase UNA SOLA VEZ
if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
    );
}

// Alias local seguro
const supabaseClient = window.supabaseClient;

/* ==============================
   COLORES
================================ */

const primaryColor = 'rgb(0, 77, 153)';
const secondaryColor = 'rgb(40, 167, 69)';
const dangerColor = 'rgb(220, 53, 69)';

/* ==============================
   L√ìGICA DE COMENTARIOS
================================ */

async function setupCommentListener() {
    const commentsListEl = document.getElementById('commentsList');
    const loadingMessageEl = document.getElementById('loadingMessage');
    if (!commentsListEl || !loadingMessageEl) return;

    loadingMessageEl.textContent = "Cargando novedades de entrega...";

    try {
        const { data: solicitudes, error } = await supabaseClient
            .from('solicitudes')
            .select(` fecha_entrega, comentario_entrega, usuarios ( nombre ) `)
            .not('comentario_entrega', 'is', null)
            .order('fecha_entrega', { ascending: false })
            .limit(5);

        if (error) throw error;

        if (!solicitudes || solicitudes.length === 0) {
            commentsListEl.innerHTML =
                `<p style="text-align:center;color:#888;">A√∫n no hay novedades registradas.</p>`;
            loadingMessageEl.textContent = "";
            return;
        }

        const escapeHTML = (str) =>
            String(str).replace(/[&<>"']/g, (m) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));

        const commentsHtml = solicitudes.map(item => {
            const usuario = item.usuarios?.nombre || 'Usuario Desconocido';
            const fecha = item.fecha_entrega
                ? new Date(item.fecha_entrega).toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'Fecha Desconocida';

            return `
                <li>
                   <strong>${usuario}</strong>
                    <span class="comment-date">${fecha}</span>
                    <div>${escapeHTML(item.comentario_entrega)}</div>
                </li>`;
        }).join('');

        commentsListEl.innerHTML = `<ul class="comments-list">${commentsHtml}</ul>`;
        loadingMessageEl.textContent = "";

    } catch (err) {
        console.error("Error al cargar novedades:", err);
        loadingMessageEl.textContent = "";
        commentsListEl.innerHTML =
            `<p style="color:${dangerColor};">Error al cargar novedades.</p>`;
    }
}

/* ==============================
   CARGA DE REPORTES (RPC)
================================ */

async function cargarReportesEstadisticos() {
    try {
        const [
            resUsuarios,
            resDocentes,
            resCarreras,
            resMateriales,
            resAsignaturas,
            resTopAsigMat
        ] = await Promise.all([
            supabaseClient.rpc('get_total_usuarios'),
            supabaseClient.rpc('get_top_docentes'),
            supabaseClient.rpc('get_solicitudes_por_carrera'),
            supabaseClient.rpc('get_top_materiales', { material_filtro: null }),
            supabaseClient.rpc('get_consumo_por_asignatura', { asignatura_filtro: null, limite: 10 }),
            supabaseClient.rpc('get_top_5_subjects_materials')
        ]);

        return {
            usuarios: resUsuarios.data?.[0] || { total_usuarios: 0 },
            docentes: resDocentes.data || [],
            carreras: resCarreras.data || [],
            materiales: resMateriales.data || [],
            asignaturas: resAsignaturas.data || [],
            topAsignaturasMateriales: resTopAsigMat.data || []
        };

    } catch (err) {
        console.error("Error en cargarReportesEstadisticos:", err);
        return null;
    }
}

/* ==============================
   RENDERIZADO
================================ */

async function renderizarReportes() {
    if (typeof Chart === 'undefined') return;

    const reportes = await cargarReportesEstadisticos();
    if (!reportes) return;

    // KPI Usuarios
    const uEl = document.getElementById('usuariosCount');
    if (uEl) {
        const p = uEl.querySelector('p:first-child');
        if (p) {
            p.textContent = Number(reportes.usuarios.total_usuarios)
                .toLocaleString('es-ES');
        }
    }

    crearBarraHorizontal(
        'docentesChart',
        'Solicitudes',
        reportes.docentes.map(d => d.docente),
        reportes.docentes.map(d => d.conteo_solicitudes),
        primaryColor
    );

    crearDona(
        'carrerasChart',
        reportes.carreras.map(c => c.carrera),
        reportes.carreras.map(c => c.conteo_solicitudes)
    );

    crearBarraHorizontal(
        'materialesChart',
        'Veces Solicitado',
        reportes.materiales.map(m => m.material),
        reportes.materiales.map(m => m.veces_solicitado),
        secondaryColor
    );

    crearBarraHorizontal(
        'asignaturasChart',
        'Solicitudes',
        reportes.asignaturas.map(a => a.asignatura),
        reportes.asignaturas.map(a => a.numero_de_solicitudes),
        dangerColor
    );

    // Gr√°fico agrupado
    if (reportes.topAsignaturasMateriales.length > 0) {
        const raw = reportes.topAsignaturasMateriales;
        const asignaturas = [...new Set(raw.map(r => r.asignatura_nombre))];
        const materiales = [...new Set(raw.map(r => r.material_nombre))];
        const colores = ['#004d99','#28a745','#ffc107','#17a2b8','#dc3545','#6c757d'];

        const datasets = materiales.map((mat, i) => ({
            label: mat,
            data: asignaturas.map(asig => {
                const reg = raw.find(r =>
                    r.asignatura_nombre === asig &&
                    r.material_nombre === mat
                );
                return reg ? Number(reg.cantidad_total) : 0;
            }),
            backgroundColor: colores[i % colores.length],
            borderRadius: 4
        }));

        crearBarraAgrupada('topAsignaturasMaterialesChart', asignaturas, datasets);
    }
}

/* ==============================
   FUNCIONES DE GR√ÅFICOS
================================ */

function crearBarraHorizontal(id, label, labels, data, color) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;

    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label, data, backgroundColor: color }] },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

function crearDona(id, labels, data) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: ['#004d99','#28a745','#ffc107','#17a2b8','#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function crearBarraAgrupada(id, labels, datasets) {
    const ctx = document.getElementById(id);
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

/* ==============================
   INICIALIZACI√ìN
================================ */

document.addEventListener("DOMContentLoaded", () => {
    renderizarReportes();
    setupCommentListener();
});
</script>

    
</body>
</html>

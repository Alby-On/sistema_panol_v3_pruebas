<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Reportes de Uso del PaÃ±ol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Variables de Color */
:root {
--color-primary: #004d99; /* Azul institucional */
--color-secondary: #28a745; /* Verde */
--color-menu: #6c757d; /* Gris para el botÃ³n de menÃº */
--color-danger: #dc3545; /* Rojo para acentuar */
--color-background: #f4f6f9; /* Fondo muy claro */
--color-card: #ffffff;
--color-text: #333333;
--shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08); /* Sombra mÃ¡s suave */
}

/* Estilos Generales y Contenedor */
body {
font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--color-background);
color: var(--color-text);
margin: 0;
padding: 0;
}
/* TÃ­tulo Principal */
h2 {
text-align: center;
color: var(--color-primary);
margin: 20px 0 10px;
font-size: 2.5em;
font-weight: 800;
}

/* CONTENEDOR DEL ENCABEZADO (BOTÃ“N Y ALINEACIÃ“N) */
.dashboard-header {
max-width: 1200px;
margin: 0 auto;
padding: 0 20px 25px 20px;
display: flex;
justify-content: space-between;
align-items: center; /* Asegura alineaciÃ³n vertical */
}
/* Estilos del botÃ³n Imprimir */
.print-button {
background-color: var(--color-secondary);
color: white;
border: none;
padding: 12px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 1.05em;
font-weight: 700;
box-shadow: 0 3px 8px rgba(40, 167, 69, 0.4);
transition: all 0.2s ease;
}

.print-button:hover {
background-color: #1e7e34;
transform: translateY(-1px);
box-shadow: 0 5px 10px rgba(40, 167, 69, 0.5);
}

/* BotÃ³n Volver al MenÃº */
.menu-button {
background-color: var(--color-menu);
color: white;
border: none;
padding: 12px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 1.05em;
font-weight: 700;
box-shadow: 0 3px 8px rgba(108, 117, 125, 0.4);
transition: all 0.2s ease;
text-decoration: none;
display: flex;
align-items: center;
gap: 5px;
}

.menu-button:hover {
background-color: #5a6268;
transform: translateY(-1px);
box-shadow: 0 5px 10px rgba(108, 117, 125, 0.5);
}

/* Grid del Dashboard: Layout vertical (una card por fila) */
.dashboard-grid {
display: grid;
grid-template-columns: 1fr;
gap: 25px;
padding: 0 20px 20px 20px;
max-width: 1200px;
margin: 0 auto;
}
/* Contenedor de cada Card/GrÃ¡fico */
.chart-container {
background: var(--color-card);
padding: 20px;
border-radius: 12px;
box-shadow: var(--shadow-subtle);
height: 600px;
display: flex;
flex-direction: column;
transition: transform 0.3s ease;
}

/* Reducimos un poco la altura de la tarjeta de comentarios, ya que no tiene el Ã¡rea de entrada */
.chart-container:nth-child(5) { 
    height: 450px; 
}


.chart-container:hover {
transform: translateY(-3px);
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}
/* Ajustes de Canvas y Altura */
.chart-container canvas {
flex-grow: 1;
max-height: 100%;
min-height: 0;
}

/* TÃ­tulos de las Tarjetas */
h3 {
color: var(--color-primary);
font-size: 1.3em;
border-bottom: 2px solid #e0e0e0;
padding-bottom: 10px;
margin-bottom: 15px;
font-weight: 700;
}

/* ESTILOS PARA LA CARD DE COMENTARIOS DINÃMICA */
.comments-content {
flex-grow: 1;
overflow-y: auto;
padding-right: 10px;
}
.comments-list {
list-style: none;
padding: 0;
margin: 0;
}
.comments-list li {
padding: 12px 0;
border-bottom: 1px dashed #e0e0e0;
font-size: 0.95em;
line-height: 1.5;
}
.comments-list li strong {
color: var(--color-primary);
font-weight: 600;
display: block;
margin-bottom: 4px;
}
.comments-list li .comment-date {
font-size: 0.8em;
color: #888;
float: right;
}
.comments-list li:last-child {
border-bottom: none;
}
/* Estilos de la zona de ingreso de comentario (ELIMINADOS) */

/* Ajustes para mÃ³viles */
@media (max-width: 768px) {
h2 { font-size: 2em; margin-top: 15px; }
.dashboard-grid { 
    grid-template-columns: 1fr; 
    padding: 10px; 
    gap: 15px; 
}
.chart-container { 
    height: 450px; 
}
.chart-container:nth-child(5) { /* Asegura que la card de comentarios se vea bien en mÃ³vil */
    height: 350px; 
}
.dashboard-header { justify-content: space-around; padding-bottom: 15px; }
}

/* Oculta el botÃ³n de impresiÃ³n al imprimir el documento */
@media print {
.dashboard-header {
display: none;
}
}
</style>
</head>
<body>
<h2>ğŸ“ˆ Panel de Reportes de Uso del PaÃ±ol</h2>
<div class="dashboard-header">
<a href="menu.html" class="menu-button">
â¬…ï¸ Volver al MenÃº
</a>
<button class="print-button" onclick="window.print()">
ğŸ–¨ï¸ Imprimir reporte
</button>
</div>
<div class="dashboard-grid">
Â  Â Â 
<div class="chart-container" style="height: 180px;">
    <h3>ğŸ‘¥ Total Usuarios Registrados</h3>
    
    <div 
        id="usuariosCount" 
        style="
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1; 
            justify-content: center; /* Centrado vertical */
        "
    >
        <p style="font-size: 4em; color: var(--color-primary); font-weight: 800; margin: 0;">0</p>
        <p style="font-size: 1.2em; color: var(--color-text); margin: 0;">Total en el Sistema</p>
    </div>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ¥‡ Top 10 Docentes Solicitantes</h3>
Â  Â  <canvas id="docentesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ›ï¸ ProporciÃ³n de Solicitudes por Carrera</h3>
Â  Â  <canvas id="carrerasChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ”© Materiales MÃ¡s Demandados (Unidades Totales)</h3>
Â  Â  <canvas id="materialesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ“š Consumo por Asignatura</h3>
Â  Â  <canvas id="asignaturasChart"></canvas>
</div>

<div class="chart-container" style="min-height: 400px;"> 
    <h3>ğŸ“Š Detalle: Top 5 Asignaturas y sus Materiales</h3>
    <canvas id="topAsignaturasMaterialesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ’¬ Registro de Novedades del PaÃ±ol</h3>
Â  Â  <div id="commentsList" class="comments-content">
Â  Â  Â  Â  <p id="loadingMessage" style="text-align: center; color: #888;">Cargando novedades...</p>
Â  Â  </div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â 
<script>
    // --- IMPORTACIONES Y CONFIGURACIÃ“N DE SUPABASE ---
    
    const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

    // Inicializar Supabase Client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Colores para los grÃ¡ficos
    const primaryColor = 'rgb(0, 77, 153)';
    const secondaryColor = 'rgb(40, 167, 69)';
    const dangerColor = 'rgb(220, 53, 69)';    

    // --- LÃ“GICA DE COMENTARIOS (Novedades de Entrega) ---

    async function setupCommentListener() {
        const commentsListEl = document.getElementById('commentsList');
        const loadingMessageEl = document.getElementById('loadingMessage');
        if (!commentsListEl || !loadingMessageEl) return;

        loadingMessageEl.textContent = "Cargando novedades de entrega...";

        try {
            const { data: solicitudes, error } = await supabase
                .from('solicitudes')
                .select(`docente, fecha_entrega, comentario_entrega`)
                .not('comentario_entrega', 'is', null)
                .order('fecha_entrega', { ascending: false })
                .limit(5);

            if (error) throw error;

            if (solicitudes.length === 0) {
                commentsListEl.innerHTML = `<p style="text-align: center; color: #888;">AÃºn no hay novedades registradas.</p>`;
                return;
            }

            const escapeHTML = (str) => String(str).replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));

            const commentsHtml = solicitudes.map(data => {
                const userDisplay = data.docente || 'Docente Desconocido';
                const date = data.fecha_entrega ? 
                    new Date(data.fecha_entrega).toLocaleString('es-ES', {  
                        day: '2-digit', month: '2-digit', year: 'numeric',  
                        hour: '2-digit', minute: '2-digit'  
                    }) : 'Fecha Desconocida';
                
                return `
                    <li>
                        <strong>${userDisplay}</strong>
                        <span class="comment-date">${date}</span>
                        <div>${escapeHTML(data.comentario_entrega)}</div>
                    </li>`;
            }).join('');

            commentsListEl.innerHTML = `<ul class="comments-list">${commentsHtml}</ul>`;
            loadingMessageEl.textContent = "";

        } catch (error) {
            console.error("Error al cargar novedades:", error);
            loadingMessageEl.textContent = "";
            commentsListEl.innerHTML = `<p style="color: ${dangerColor};">Error al cargar novedades.</p>`;
        }
    }

    // --- LÃ“GICA DE DATOS (Supabase RPC) ---
    
    async function cargarReportesEstadisticos() {
        try {
            // Ejecutar todas las llamadas necesarias
            const { data: totalUsuarios } = await supabase.rpc('get_total_usuarios');
            const { data: docentes } = await supabase.rpc('get_top_docentes');
            const { data: carreras } = await supabase.rpc('get_solicitudes_por_carrera');
            const { data: materiales } = await supabase.rpc('get_top_materiales', { material_filtro: null });
            
            const { data: asignaturas } = await supabase.rpc('get_consumo_por_asignatura', { 
                asignatura_filtro: null,
                limite: 10 
            });

            // Nueva funciÃ³n para el grÃ¡fico agrupado
            const { data: topAsigMat, error: errTopAsig } = await supabase.rpc('get_top_5_subjects_materials');
            if (errTopAsig) console.warn("Aviso: get_top_5_subjects_materials fallÃ³ o no existe.");

            // UN SOLO RETURN con todos los datos consolidados
            return {
                docentes: docentes || [],
                carreras: carreras || [],
                materiales: materiales || [],
                asignaturas: asignaturas || [],
                topAsignaturasMateriales: topAsigMat || [],
                usuarios: totalUsuarios ? totalUsuarios[0] : { total_usuarios: 0 }, 
            };

        } catch (error) {
            console.error("Error general en cargarReportesEstadisticos:", error);
            return { docentes: [], carreras: [], materiales: [], asignaturas: [], topAsignaturasMateriales: [], usuarios: { total_usuarios: 0 } };
        }
    }

    // --- LÃ“GICA DE RENDERIZADO (Chart.js) ---

    async function renderizarReportes() {
        if (typeof Chart === 'undefined') return;

        const reportes = await cargarReportesEstadisticos();

        // 0. KPI Usuarios
        const usuariosCountEl = document.getElementById('usuariosCount');
        if (usuariosCountEl) {
            const total = reportes.usuarios.total_usuarios ? Number(reportes.usuarios.total_usuarios).toLocaleString('es-ES') : '0';
            const p = usuariosCountEl.querySelector('p:first-child');
            if(p) p.textContent = total;
        }

        // 1. Docentes
        crearBarraHorizontal('docentesChart', 'Solicitudes', reportes.docentes.map(d => d.docente), reportes.docentes.map(d => d.conteo_solicitudes), primaryColor, ' sol.');

        // 2. Carreras
        crearDona('carrerasChart', 'Solicitudes por Carrera', reportes.carreras.map(c => c.carrera), reportes.carreras.map(c => c.conteo_solicitudes));

        // 3. Materiales
        crearBarraHorizontal('materialesChart', 'Veces Solicitado', reportes.materiales.map(m => m.material), reportes.materiales.map(m => m.veces_solicitado), secondaryColor, ' veces');

        // 4. Asignaturas
        crearBarraHorizontal('asignaturasChart', 'NÃºmero de Solicitudes', reportes.asignaturas.map(a => a.asignatura), reportes.asignaturas.map(a => a.numero_de_solicitudes), dangerColor, ' sol.');

        // 5. NUEVO: GrÃ¡fico Agrupado (Asignaturas + Materiales)
        const canvasAgrupado = document.getElementById('topAsignaturasMaterialesChart');
        if (canvasAgrupado && reportes.topAsignaturasMateriales.length > 0) {
            const dataRaw = reportes.topAsignaturasMateriales;
            const labelsAsignaturas = [...new Set(dataRaw.map(d => d.asignatura_nombre))];
            const nombresMateriales = [...new Set(dataRaw.map(d => d.material_nombre))];
            const paleta = ['#004d99', '#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6c757d'];

            const datasets = nombresMateriales.map((mat, i) => ({
                label: mat,
                data: labelsAsignaturas.map(asig => {
                    const reg = dataRaw.find(d => d.asignatura_nombre === asig && d.material_nombre === mat);
                    return reg ? Number(reg.cantidad_total) : 0;
                }),
                backgroundColor: paleta[i % paleta.length],
                borderRadius: 4
            }));

            crearBarraAgrupada('topAsignaturasMaterialesChart', labelsAsignaturas, datasets);
        }
    }

    // --- FUNCIONES AUXILIARES DE CHART ---

    function crearBarraHorizontal(id, label, labels, data, color, unit) {
        if (!document.getElementById(id) || labels.length === 0) return;
        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: label, data: data, backgroundColor: color }]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    }

    function crearDona(id, label, labels, data) {
        if (!document.getElementById(id) || labels.length === 0) return;
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: ['#004d99', '#28a745', '#ffc107', '#17a2b8', '#dc3545'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function crearBarraAgrupada(id, labels, datasets) {
        new Chart(document.getElementById(id), {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Plugin para el centro de la Dona
    const totalDoughnutPlugin = {
        id: 'totalDoughnut',
        beforeDraw(chart) {
            if (chart.config.type === 'doughnut') {
                const { ctx, data, width, height } = chart;
                ctx.save();
                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = primaryColor;
                ctx.font = 'bold 24px sans-serif';
                ctx.fillText(total.toLocaleString('es-ES'), width / 2, height / 2 - 10);
                ctx.font = '12px sans-serif';
                ctx.fillText('Total', width / 2, height / 2 + 15);
                ctx.restore();
            }
        }
    };
    Chart.register(totalDoughnutPlugin);

    document.addEventListener("DOMContentLoaded", () => {
        renderizarReportes();
        setupCommentListener();
    });
</script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Reportes de Uso del PaÃ±ol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Variables de Color */
:root {
--color-primary: #004d99; /* Azul institucional */
--color-secondary: #28a745; /* Verde */
--color-menu: #6c757d; /* Gris para el botÃ³n de menÃº */
--color-danger: #dc3545; /* Rojo para acentuar */
--color-background: #f4f6f9; /* Fondo muy claro */
--color-card: #ffffff;
--color-text: #333333;
--shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08); /* Sombra mÃ¡s suave */
}

/* Estilos Generales y Contenedor */
body {
font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--color-background);
color: var(--color-text);
margin: 0;
padding: 0;
}
/* TÃ­tulo Principal */
h2 {
text-align: center;
color: var(--color-primary);
margin: 20px 0 10px;
font-size: 2.5em;
font-weight: 800;
}

/* CONTENEDOR DEL ENCABEZADO (BOTÃ“N Y ALINEACIÃ“N) */
.dashboard-header {
max-width: 1200px;
margin: 0 auto;
padding: 0 20px 25px 20px;
display: flex;
justify-content: space-between;
align-items: center; /* Asegura alineaciÃ³n vertical */
}
/* Estilos del botÃ³n Imprimir */
.print-button {
background-color: var(--color-secondary);
color: white;
border: none;
padding: 12px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 1.05em;
font-weight: 700;
box-shadow: 0 3px 8px rgba(40, 167, 69, 0.4);
transition: all 0.2s ease;
}

.print-button:hover {
background-color: #1e7e34;
transform: translateY(-1px);
box-shadow: 0 5px 10px rgba(40, 167, 69, 0.5);
}

/* BotÃ³n Volver al MenÃº */
.menu-button {
background-color: var(--color-menu);
color: white;
border: none;
padding: 12px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 1.05em;
font-weight: 700;
box-shadow: 0 3px 8px rgba(108, 117, 125, 0.4);
transition: all 0.2s ease;
text-decoration: none;
display: flex;
align-items: center;
gap: 5px;
}

.menu-button:hover {
background-color: #5a6268;
transform: translateY(-1px);
box-shadow: 0 5px 10px rgba(108, 117, 125, 0.5);
}

/* Grid del Dashboard: Layout vertical (una card por fila) */
.dashboard-grid {
display: grid;
grid-template-columns: 1fr;
gap: 25px;
padding: 0 20px 20px 20px;
max-width: 1200px;
margin: 0 auto;
}
/* Contenedor de cada Card/GrÃ¡fico */
.chart-container {
background: var(--color-card);
padding: 20px;
border-radius: 12px;
box-shadow: var(--shadow-subtle);
height: 600px;
display: flex;
flex-direction: column;
transition: transform 0.3s ease;
}

/* Reducimos un poco la altura de la tarjeta de comentarios, ya que no tiene el Ã¡rea de entrada */
.chart-container:nth-child(5) { 
    height: 450px; 
}


.chart-container:hover {
transform: translateY(-3px);
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}
/* Ajustes de Canvas y Altura */
.chart-container canvas {
flex-grow: 1;
max-height: 100%;
min-height: 0;
}

/* TÃ­tulos de las Tarjetas */
h3 {
color: var(--color-primary);
font-size: 1.3em;
border-bottom: 2px solid #e0e0e0;
padding-bottom: 10px;
margin-bottom: 15px;
font-weight: 700;
}

/* ESTILOS PARA LA CARD DE COMENTARIOS DINÃMICA */
.comments-content {
flex-grow: 1;
overflow-y: auto;
padding-right: 10px;
}
.comments-list {
list-style: none;
padding: 0;
margin: 0;
}
.comments-list li {
padding: 12px 0;
border-bottom: 1px dashed #e0e0e0;
font-size: 0.95em;
line-height: 1.5;
}
.comments-list li strong {
color: var(--color-primary);
font-weight: 600;
display: block;
margin-bottom: 4px;
}
.comments-list li .comment-date {
font-size: 0.8em;
color: #888;
float: right;
}
.comments-list li:last-child {
border-bottom: none;
}
/* Estilos de la zona de ingreso de comentario (ELIMINADOS) */

/* Ajustes para mÃ³viles */
@media (max-width: 768px) {
h2 { font-size: 2em; margin-top: 15px; }
.dashboard-grid { 
    grid-template-columns: 1fr; 
    padding: 10px; 
    gap: 15px; 
}
.chart-container { 
    height: 450px; 
}
.chart-container:nth-child(5) { /* Asegura que la card de comentarios se vea bien en mÃ³vil */
    height: 350px; 
}
.dashboard-header { justify-content: space-around; padding-bottom: 15px; }
}

/* Oculta el botÃ³n de impresiÃ³n al imprimir el documento */
@media print {
.dashboard-header {
display: none;
}
}
</style>
</head>
<body>
<h2>ğŸ“ˆ Panel de Reportes de Uso del PaÃ±ol</h2>
<div class="dashboard-header">
<a href="menu.html" class="menu-button">
â¬…ï¸ Volver al MenÃº
</a>
<button class="print-button" onclick="window.print()">
ğŸ–¨ï¸ Imprimir reporte
</button>
</div>
<div class="dashboard-grid">
Â  Â Â 
<div class="chart-container" style="height: 180px;">
    <h3>ğŸ‘¥ Total Usuarios Registrados</h3>
    
    <div 
        id="usuariosCount" 
        style="
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1; 
            justify-content: center; /* Centrado vertical */
        "
    >
        <p style="font-size: 4em; color: var(--color-primary); font-weight: 800; margin: 0;">0</p>
        <p style="font-size: 1.2em; color: var(--color-text); margin: 0;">Total en el Sistema</p>
    </div>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ¥‡ Top 10 Docentes Solicitantes</h3>
Â  Â  <canvas id="docentesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ›ï¸ ProporciÃ³n de Solicitudes por Carrera</h3>
Â  Â  <canvas id="carrerasChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ”© Materiales MÃ¡s Demandados (Unidades Totales)</h3>
Â  Â  <canvas id="materialesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ“š Consumo por Asignatura</h3>
Â  Â  <canvas id="asignaturasChart"></canvas>
</div>

<div class="chart-container" style="min-height: 400px;"> 
    <h3>ğŸ“Š Detalle: Top 5 Asignaturas y sus Materiales</h3>
    <canvas id="topAsignaturasMaterialesChart"></canvas>
</div>

<div class="chart-container">
Â  Â  <h3>ğŸ’¬ Registro de Novedades del PaÃ±ol</h3>
Â  Â  <div id="commentsList" class="comments-content">
Â  Â  Â  Â  <p id="loadingMessage" style="text-align: center; color: #888;">Cargando novedades...</p>
Â  Â  </div>
</div>

</div>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â 
<script>
/* ==============================
   CONFIGURACIÃ“N SUPABASE
================================ */

const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

// Crear cliente Supabase UNA SOLA VEZ
if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
    );
}

// Alias local seguro
const supabaseClient = window.supabaseClient;

/* ==============================
   COLORES
================================ */

const primaryColor = 'rgb(0, 77, 153)';
const secondaryColor = 'rgb(40, 167, 69)';
const dangerColor = 'rgb(220, 53, 69)';

/* ==============================
   LÃ“GICA DE COMENTARIOS
================================ */

async function setupCommentListener() {
    const commentsListEl = document.getElementById('commentsList');
    const loadingMessageEl = document.getElementById('loadingMessage');
    if (!commentsListEl || !loadingMessageEl) return;

    loadingMessageEl.textContent = "Cargando novedades de entrega...";

    try {
        const { data: solicitudes, error } = await supabaseClient
            .from('solicitudes')
            .select('docente, fecha_entrega, comentario_entrega')
            .not('comentario_entrega', 'is', null)
            .order('fecha_entrega', { ascending: false })
            .limit(5);

        if (error) throw error;

        if (!solicitudes || solicitudes.length === 0) {
            commentsListEl.innerHTML =
                `<p style="text-align:center;color:#888;">AÃºn no hay novedades registradas.</p>`;
            loadingMessageEl.textContent = "";
            return;
        }

        const escapeHTML = (str) =>
            String(str).replace(/[&<>"']/g, (m) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));

        const commentsHtml = solicitudes.map(item => {
            const docente = item.docente || 'Docente Desconocido';
            const fecha = item.fecha_entrega
                ? new Date(item.fecha_entrega).toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'Fecha Desconocida';

            return `
                <li>
                    <strong>${docente}</strong>
                    <span class="comment-date">${fecha}</span>
                    <div>${escapeHTML(item.comentario_entrega)}</div>
                </li>`;
        }).join('');

        commentsListEl.innerHTML = `<ul class="comments-list">${commentsHtml}</ul>`;
        loadingMessageEl.textContent = "";

    } catch (err) {
        console.error("Error al cargar novedades:", err);
        loadingMessageEl.textContent = "";
        commentsListEl.innerHTML =
            `<p style="color:${dangerColor};">Error al cargar novedades.</p>`;
    }
}

/* ==============================
   CARGA DE REPORTES (RPC)
================================ */

async function cargarReportesEstadisticos() {
    try {
        const [
            resUsuarios,
            resDocentes,
            resCarreras,
            resMateriales,
            resAsignaturas,
            resTopAsigMat
        ] = await Promise.all([
            supabaseClient.rpc('get_total_usuarios'),
            supabaseClient.rpc('get_top_docentes'),
            supabaseClient.rpc('get_solicitudes_por_carrera'),
            supabaseClient.rpc('get_top_materiales', { material_filtro: null }),
            supabaseClient.rpc('get_consumo_por_asignatura', { asignatura_filtro: null, limite: 10 }),
            supabaseClient.rpc('get_top_5_subjects_materials')
        ]);

        return {
            usuarios: resUsuarios.data?.[0] || { total_usuarios: 0 },
            docentes: resDocentes.data || [],
            carreras: resCarreras.data || [],
            materiales: resMateriales.data || [],
            asignaturas: resAsignaturas.data || [],
            topAsignaturasMateriales: resTopAsigMat.data || []
        };

    } catch (err) {
        console.error("Error en cargarReportesEstadisticos:", err);
        return null;
    }
}

/* ==============================
   RENDERIZADO
================================ */

async function renderizarReportes() {
    if (typeof Chart === 'undefined') return;

    const reportes = await cargarReportesEstadisticos();
    if (!reportes) return;

    // KPI Usuarios
    const uEl = document.getElementById('usuariosCount');
    if (uEl) {
        const p = uEl.querySelector('p:first-child');
        if (p) {
            p.textContent = Number(reportes.usuarios.total_usuarios)
                .toLocaleString('es-ES');
        }
    }

    crearBarraHorizontal(
        'docentesChart',
        'Solicitudes',
        reportes.docentes.map(d => d.docente),
        reportes.docentes.map(d => d.conteo_solicitudes),
        primaryColor
    );

    crearDona(
        'carrerasChart',
        reportes.carreras.map(c => c.carrera),
        reportes.carreras.map(c => c.conteo_solicitudes)
    );

    crearBarraHorizontal(
        'materialesChart',
        'Veces Solicitado',
        reportes.materiales.map(m => m.material),
        reportes.materiales.map(m => m.veces_solicitado),
        secondaryColor
    );

    crearBarraHorizontal(
        'asignaturasChart',
        'Solicitudes',
        reportes.asignaturas.map(a => a.asignatura),
        reportes.asignaturas.map(a => a.numero_de_solicitudes),
        dangerColor
    );

    // GrÃ¡fico agrupado
    if (reportes.topAsignaturasMateriales.length > 0) {
        const raw = reportes.topAsignaturasMateriales;
        const asignaturas = [...new Set(raw.map(r => r.asignatura_nombre))];
        const materiales = [...new Set(raw.map(r => r.material_nombre))];
        const colores = ['#004d99','#28a745','#ffc107','#17a2b8','#dc3545','#6c757d'];

        const datasets = materiales.map((mat, i) => ({
            label: mat,
            data: asignaturas.map(asig => {
                const reg = raw.find(r =>
                    r.asignatura_nombre === asig &&
                    r.material_nombre === mat
                );
                return reg ? Number(reg.cantidad_total) : 0;
            }),
            backgroundColor: colores[i % colores.length],
            borderRadius: 4
        }));

        crearBarraAgrupada('topAsignaturasMaterialesChart', asignaturas, datasets);
    }
}

/* ==============================
   FUNCIONES DE GRÃFICOS
================================ */

function crearBarraHorizontal(id, label, labels, data, color) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;

    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label, data, backgroundColor: color }] },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

function crearDona(id, labels, data) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: ['#004d99','#28a745','#ffc107','#17a2b8','#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function crearBarraAgrupada(id, labels, datasets) {
    const ctx = document.getElementById(id);
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

/* ==============================
   INICIALIZACIÃ“N
================================ */

document.addEventListener("DOMContentLoaded", () => {
    renderizarReportes();
    setupCommentListener();
});
</script>

    
</body>
</html>
